{% extends "base.html" %}

{% block title %}{{ session.name }} - 面试会话{% endblock %}

{% block extra_css %}
<style>
    .candidate-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .interview-container {
        height: calc(100vh - 200px);
        display: flex;
        gap: 1rem;
    }
    
    .sidebar {
        width: 350px;
        max-height: 100%;
        overflow-y: auto;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    @media (max-width: 992px) {
        .interview-container {
            flex-direction: column;
            height: auto;
        }
        
        .sidebar {
            width: 100%;
            max-height: 300px;
        }
        
        .chat-area {
            height: calc(100vh - 350px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 面包屑导航 -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('main.index') }}">
                        <i class="fas fa-home me-1"></i>首页
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('main.room_detail', room_id=session.room_id) }}">
                        <i class="fas fa-door-open me-1"></i>面试间
                    </a>
                </li>
                <li class="breadcrumb-item active">
                    <i class="fas fa-comments me-1"></i>{{ session.name }}
                </li>
            </ol>
        </nav>
        
        <!-- 主要面试界面 -->
        <div class="interview-container">
            <!-- 左侧边栏：候选人信息和简历 -->
            <div class="sidebar">
                {% if resume %}
                <!-- 候选人基本信息 -->
                <div class="candidate-info">
                    <div class="text-center mb-3">
                        <div class="candidate-avatar mb-2">
                            <i class="fas fa-user-circle fa-3x"></i>
                        </div>
                        <h5 class="mb-1">{{ resume.name }}</h5>
                        <p class="mb-0 opacity-75">{{ resume.position }}</p>
                    </div>
                    
                    <div class="candidate-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end border-light border-opacity-50">
                                    <h6 class="mb-0">{{ resume.skills|length }}</h6>
                                    <small class="opacity-75">技能项目</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 class="mb-0">{{ resume.projects|length }}</h6>
                                <small class="opacity-75">项目经验</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 技能列表 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>技能栈
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="skill-tags">
                            {% for skill in resume.skills %}
                            <div class="skill-item mb-2 p-2 border rounded">
                                <small class="text-muted">{{ loop.index }}.</small>
                                <span class="ms-1" style="font-size: 0.85rem;">{{ skill[:80] }}{% if skill|length > 80 %}...{% endif %}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- 项目经验 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>项目经验
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        {% for project in resume.projects %}
                        <div class="project-item mb-2 p-2 border rounded">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-code text-primary me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted">项目 {{ loop.index }}</small>
                                    <div style="font-size: 0.85rem;" class="mt-1">
                                        {{ project[:100] }}{% if project|length > 100 %}...{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- 右侧：ChatGPT风格对话界面 -->
            <div class="chat-area">
                <div class="chat-container">
                    <!-- 聊天头部 -->
                    <div class="chat-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">{{ session.name }}</h6>
                                <small class="opacity-75">AI智能面试官</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-light" onclick="generateQuestions()">
                                    <i class="fas fa-plus me-1"></i>生成面试题
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 消息区域 -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- 欢迎消息 -->
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>您好！我是您的AI面试官。我已经查看了您的简历，准备开始面试。</div>
                                <div class="message-time">{{ session.created_at[:19]|replace('T', ' ') }}</div>
                            </div>
                        </div>
                        
                        <!-- 动态加载的对话轮次 -->
                        {% for round in rounds %}
                        <div class="round-header" data-round-id="{{ round.id }}">
                            <span>第{{ round.round_index + 1 }}轮面试题</span>
                        </div>
                        
                        <!-- AI生成的问题 -->
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>我为您准备了以下{{ round.questions|length }}道面试题：</div>
                                <div class="questions-container mt-3">
                                    {% for question in round.questions %}
                                    <div class="question-card mb-2">
                                        <div class="question-text">
                                            <span class="question-number">{{ loop.index }}.</span>
                                            {{ question }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="message-time">{{ round.created_at[:19]|replace('T', ' ') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- 加载指示器 -->
                        <div class="typing-indicator" id="typingIndicator" style="display: none;">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div>
                                AI正在生成面试题
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 输入区域 -->
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="您可以回答面试题或请求生成新的题目..." 
                                   id="messageInput"
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                按回车发送消息 | 
                                <a href="javascript:generateQuestions()" class="text-decoration-none">点击生成新的面试题</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 由后端注入：数字人启动提示与链接（可能为 null）
const DH_BOOT_MESSAGE = {{ dh_message|tojson|safe if dh_message else 'null' }};
const DH_CONNECT_URL = {{ dh_connect_url|tojson|safe if dh_connect_url else 'null' }};

// 全局会话ID和当前轮次状态
const SESSION_ID = '{{ session.id }}';
let currentRoundId = null;
let currentQuestionData = null;

// 页面加载完成后滚动到底部 + 如果有数字人提示则插入一条AI消息
$(document).ready(function() {
    scrollToBottom();
    console.log('面试会话页面已加载');

    if (DH_BOOT_MESSAGE) {
        addMessage('ai', DH_BOOT_MESSAGE);
    }

    // 检查是否有进行中的轮次
    checkActiveRound();
});

// 检查是否有进行中的轮次
async function checkActiveRound() {
    // 查找页面中的最后一个轮次
    const rounds = document.querySelectorAll('.round-header');
    if (rounds.length > 0) {
        // 从最后一个轮次header提取round_id
        const lastRound = rounds[rounds.length - 1];
        const roundData = lastRound.dataset.roundId;
        if (roundData) {
            currentRoundId = roundData;
            // 尝试加载当前问题
            await loadCurrentQuestion();
        }
    }
}

// 滚动到消息底部
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// 处理键盘按键
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// 发送消息（处理用户回答）
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (message && currentQuestionData) {
        // 添加用户消息到聊天区域
        addMessage('user', message);
        input.value = '';

        // 保存回答到后端
        saveAnswer(currentQuestionData.qa_id, message);
    } else if (message && !currentQuestionData) {
        // 没有当前问题时的普通聊天
        addMessage('user', message);
        input.value = '';

        // 模拟AI回复
        setTimeout(() => {
            addMessage('ai', '感谢您的回答。如果您准备好了，可以点击"生成面试题"开始面试。');
        }, 1000);
    }
}

// 添加消息到聊天区域
function addMessage(type, content) {
    const chatMessages = document.getElementById('chatMessages');
    const messageTime = new Date().toLocaleString('zh-CN');
    
    const messageHTML = `
        <div class="message ${type}">
            <div class="message-avatar">
                <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div>${content}</div>
                <div class="message-time">${messageTime}</div>
            </div>
        </div>
    `;
    
    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
    scrollToBottom();
}

// 生成面试题
async function generateQuestions() {
    const headerButton = document.querySelector('.chat-header button');
    const button = headerButton || (event && event.target && event.target.closest('button'));
    
    let originalContent = '';
    if (button) {
        originalContent = button.innerHTML;
    }
    
    try {
        if (button) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>生成中...';
            button.disabled = true;
        }
        document.getElementById('typingIndicator').style.display = 'flex';
        scrollToBottom();
        
        const response = await fetch(`/generate_questions/${SESSION_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        document.getElementById('typingIndicator').style.display = 'none';
        
        if (data.success) {
            currentRoundId = data.round_id;

            const roundHeader = `
                <div class="round-header" data-round-id="${data.round_id}">
                    <span>第${data.round_index + 1}轮面试题</span>
                </div>
            `;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', roundHeader);

            addMessage('ai', `好的！我为您准备了${data.questions.length}道面试题。让我们逐一进行，请仔细回答每一道题目。`);
            YeyingInterviewer.showToast('success', `成功生成${data.questions.length}道面试题`);

            await loadCurrentQuestion();
        } else {
            YeyingInterviewer.showToast('error', data.error || '生成面试题失败');
        }
        
    } catch (error) {
        console.error('生成面试题失败:', error);
        YeyingInterviewer.showToast('error', '网络请求失败，请稍后再试');
        document.getElementById('typingIndicator').style.display = 'none';
    } finally {
        if (button && originalContent) {
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }
}

// 加载当前问题
async function loadCurrentQuestion() {
    if (!currentRoundId) return;

    try {
        const response = await fetch(`/get_current_question/${currentRoundId}`);
        const data = await response.json();

        if (data.success && data.question_data) {
            currentQuestionData = data.question_data;

            const questionHTML = `
                <div class="current-question-info mb-2">
                    <small class="text-muted">【${data.question_data.category}】问题 ${data.question_data.question_number}/${data.question_data.total_questions}</small>
                </div>
                <div class="question-text">${data.question_data.question}</div>
                <div class="mt-2">
                    <small class="text-info">请在下方输入框中回答这个问题...</small>
                </div>
            `;

            addMessage('ai', questionHTML);

            const input = document.getElementById('messageInput');
            input.placeholder = `请回答第${data.question_data.question_number}题...`;
            input.focus();

        } else {
            currentQuestionData = null;
            addMessage('ai', '🎉 恭喜！您已经完成了本轮所有面试题。您可以生成新的一轮面试题继续练习。');

            const input = document.getElementById('messageInput');
            input.placeholder = '您可以回答面试题或请求生成新的题目...';
        }

    } catch (error) {
        console.error('加载问题失败:', error);
        YeyingInterviewer.showToast('error', '加载问题失败');
    }
}

// 保存用户回答
async function saveAnswer(qaId, answerText) {
    try {
        const response = await fetch('/save_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qa_id: qaId, answer_text: answerText })
        });

        const data = await response.json();

        if (data.success) {
            setTimeout(() => {
                if (data.is_round_completed) {
                    addMessage('ai', '✅ 回答已保存！🎉 您已完成本轮所有面试题，表现出色！');
                    currentQuestionData = null;

                    const input = document.getElementById('messageInput');
                    input.placeholder = '您可以回答面试题或请求生成新的题目...';
                } else {
                    addMessage('ai', `✅ 回答已保存！还有 ${data.remaining_questions} 道题，让我们继续下一题。`);
                    setTimeout(() => loadCurrentQuestion(), 1000);
                }
            }, 500);

        } else {
            YeyingInterviewer.showToast('error', data.error || '保存回答失败');
        }

    } catch (error) {
        console.error('保存回答失败:', error);
        YeyingInterviewer.showToast('error', '保存回答失败');
    }
}

// 页面卸载时的清理
$(window).on('beforeunload', function() {
    console.log('面试会话页面即将卸载');
});
</script>
{% endblock %}
